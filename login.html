<html>
<head>
  <title>WeaveID</title>
  <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tailwindcss/ui@latest/dist/tailwind-ui.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css">
  <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
  <link rel="icon" href="/img/favicon.png" type="image/x-icon">
</head>
<body>

<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/animate.min.css" />

<script src="https://unpkg.com/penpal/dist/penpal.min.js"></script>
<script type="module" src="js/bundle.js"></script>
<script src="/js/pem2jwk.bundle.js"></script>
<script src="https://unpkg.com/arweave/bundles/web.bundle.min.js"></script>
<script src="/js/ethereum-wallets.js"></script>

<script type="text/javascript">
var key;
var jwk;
var arweave;
var address;
var balance;
var iframeConnection;
var transaction;

// Close modal function that we'll call from the main page
var closeModal = function() {};
var closeAll = function() {
  hideConfirmation();
  closeModal();
}

// INIT:
document.addEventListener("DOMContentLoaded", function (event) {
  var savedKey = localStorage.getItem("weaveid-wallet-pk");
  if(savedKey) {
    key = savedKey;
    showResults(JSON.parse(savedKey));
  } else {
    showLogin();
  }
});

function animateCSS(element, animation, prefix = "animate__", speed = "faster") {
  // We create a Promise and return it
  return new Promise((resolve, reject) => {
    var animationName = `${prefix}${animation}`;
    var animationSpeed = `${prefix}${speed}`;
    var node = document.querySelector(element);
    node.classList.add(`${prefix}animated`, animationName, animationSpeed);

    // When the animation ends, we clean the classes and resolve the Promise
    function handleAnimationEnd() {
      node.classList.remove(`${prefix}animated`, animationName);
      node.removeEventListener("animationend", handleAnimationEnd);
      resolve("Animation ended");
    }
    node.addEventListener("animationend", handleAnimationEnd);
  });
}

function generateKey() {
  var email = document.getElementById("email").value;
  var password = document.getElementById("password").value;
  if(!email || !password) {
    showError("Please enter an email and password.");
  } else {
    // Generate private key:
    var keyPair = module.getKeyPairFromSeed(btoa(email + "+" + password), { id: 'rsa', modulusLength: 4096 }, {privateKeyFormat: 'pkcs1-pem'}).then(function(response) {
      key = response.privateKey;

      // Generate JWK wallet for arweave:
      jwk = pem2jwk(key);
      console.log("jwk = ", jwk);
      // TODO: Unset key AND response here

      // Check wallet with ArweaveJS:
      arweave = Arweave.init({
        host: 'arweave.net',// Hostname or IP address for a Arweave host
        port: 443,          // Port
        protocol: 'https',  // Network protocol http or https
        timeout: 20000,     // Network request timeouts in milliseconds
        logging: false,     // Enable network request logging
      });
      arweave.wallets.jwkToAddress(jwk).then(function(addy) {
        address = addy;
        console.log("Address = ", address);
        arweave.wallets.getBalance(address).then(function(bal) {
          balance = arweave.ar.winstonToAr(bal);
          console.log("Balance = ", balance);
          animateCSS("#login-view", "fadeOut").then(function(msg) {
            document.getElementById("login-view").style.display = "none";
            // Show success icon:
            animateCSS("#success", "fadeIn").then(function(msg) {
              // Show results page:
              animateCSS("#success", "fadeOut").then(function(msg) {
                showResults(response);
                updateBalance(balance);
                // Expose Arweave methods (by overwriting):
                if(iframeConnection) iframeConnection.overwriteArweaveMethods();
             });

            });
          });

        });
      });

      // Save the key if they checked "Remember Me":
      // TODO: Save as encrypted JWK?
      if(document.getElementById("remember").checked) localStorage.setItem("weaveid-wallet-pk", JSON.stringify(response));
    }).catch(function(e){
      // Show errors:
      showError(e);
    });

    // Show loader:
    console.log("Generating private key...", keyPair);
    showLoader();
  }
}

function showError(err) {
  document.getElementById('error').innerHTML = err;
  document.getElementById('error').style.display = 'block';
  showLogin();
}

function showLoader() {
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('error').style.display = 'none';
  document.getElementById('loader').style.display = 'block';
}

function showResults(privateKey) {
  if(address) document.getElementById('public-key').innerHTML = address;
  document.getElementById('loader').style.display = 'none';
  document.getElementById('login-view').style.display = 'none';
  document.getElementById('results').style.display = 'block';
}

function updateBalance(bal) {
  document.getElementById('balance').innerHTML = bal;
}

function showLogin() {
  document.getElementById('loader').style.display = 'none';
  document.getElementById('login-view').style.display = 'block';
  document.getElementById('login-form').style.display = 'block';
  document.getElementById('results').style.display = 'none';
}

function showConfirmation(address, amount) {
  document.getElementById('confirm-address').innerHTML = address;
  document.getElementById('confirm-amount').innerHTML = amount;
  document.getElementById('confirm-view').style.display = 'block';
}

function hideConfirmation() {
  document.getElementById('confirm-view').style.display = 'none';
  document.getElementById('confirm-address').innerHTML = '';
  document.getElementById('confirm-amount').innerHTML = '';
}

function submitForm(e) {
  var key=e.keyCode || e.which;
   if (key==13){
      generateKey();
   }
}
</script>


<!-- Main Template begins -->
<div class="min-h-screen flex items-center justify-center bg-gray-50 py-2 sm:py-12 px-4 sm:px-6 lg:px-8">
  <!-- CONFIRM TRANSACTION -->
  <div id="confirm-view" class="w-full md:w-1/3">
    <img src="/img/success.svg" class="mx-auto h-24 mb-4"/>
    <div>
      Address: <span id="confirm-address">0x0</span> / Amount: <span id="confirm-amount">0</span>
    </div>
    <button id="confirm-button" class="group mb-1 relative w-full flex justify-center py-2 px-4 border border-transparent font-medium rounded text-white bg-indigo-600 hover:bg-indigo-500 focus:outline-none focus:border-indigo-700 focus:shadow-outline-indigo active:bg-indigo-700 transition duration-150 ease-in-out">
      Confirm
    </button>
    <button onclick="closeAll()" class="group mb-1 relative w-full flex justify-center py-2 px-4 border border-transparent font-medium rounded text-white bg-indigo-600 hover:bg-indigo-500 focus:outline-none focus:border-indigo-700 focus:shadow-outline-indigo active:bg-indigo-700 transition duration-150 ease-in-out">
      Cancel
    </button>
  </div>

  <!-- SUCCESS -->
  <div id="success" class="w-full md:w-1/3">
    <img src="/img/success.svg" class="mx-auto h-24 mb-4"/>
    <h2 class="text-3xl font-bold text-center text-green-500 mb-6">Success!</h2>
  </div>
  <!-- RESULTS -->
  <div id="results" class="w-full md:w-1/3">
    <h3 class="font-bold text-center">Your Wallet:</h3>
    <div id="public-key" class="mt-2"></div>
    <div id="balance-holder" class="mt-2 text-center">Balance = <b><span id="balance">0.00</span> AR</b></div>
    <br />
    <button class="group mb-1 relative w-full flex justify-center py-2 px-4 border border-transparent font-medium rounded text-white bg-indigo-600 hover:bg-indigo-500 focus:outline-none focus:border-indigo-700 focus:shadow-outline-indigo active:bg-indigo-700 transition duration-150 ease-in-out">
      <span class="absolute left-0 inset-y-0 flex items-center pl-3">
        <svg class="h-5 w-5 text-indigo-500 group-hover:text-indigo-400 transition ease-in-out duration-150" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
        </svg>
      </span>
      Buy AR with Debit Card
    </button>
    <button onclick="closeAll()" class="w-full bg-transparent hover:bg-indigo-500 text-blue-700 font-semibold hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded">
      Close
    </button>

  </div>

  <!-- LOGIN VIEW -->
  <div class="max-w-md w-full" id="login-view">
    <div>
      <img class="mx-auto h-24 w-auto" src="img/logo.svg" alt="Workflow" id="logo"/>
      <h2 class="mt-6 text-center text-3xl leading-9 font-extrabold text-gray-900">
        Sign in to your WeaveID
      </h2>
      <p class="mt-2 text-center text-sm leading-5 text-gray-600">
        Or
        <a href="https://www.arweave.org/wallet" target="_blank" class="font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:underline transition ease-in-out duration-150">
          create your free Arweave wallet
        </a>
      </p>

      <!-- ERRORS -->
      <p class="text-red-500" id="error"></p>
    </div>

    <!-- LOADER -->
    <img src="img/pulse.gif" id="loader" />

    <!-- LOGIN FORM -->
    <div class="mt-8" id="login-form">
      <div class="rounded-md shadow-sm">
        <div>
          <input aria-label="Email address" onkeypress="submitForm(event)" id="email" name="email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:shadow-outline-blue focus:border-blue-300 focus:z-10 sm:text-sm sm:leading-5" placeholder="Email address" />
        </div>
        <div class="-mt-px">
          <input aria-label="Password" onkeypress="submitForm(event)" id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:shadow-outline-blue focus:border-blue-300 focus:z-10 sm:text-sm sm:leading-5" placeholder="Password" />
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <div class="flex items-center">
          <input id="remember" type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out" />
          <label for="remember" class="ml-2 block text-sm leading-5 text-gray-900">
            Remember me
          </label>
        </div>

        <div class="text-sm leading-5">
          <a href="#" class="font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:underline transition ease-in-out duration-150">
            Forgot your password?
          </a>
        </div>
      </div>

      <div class="mt-6">
        <button onclick="generateKey()" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-500 focus:outline-none focus:border-indigo-700 focus:shadow-outline-indigo active:bg-indigo-700 transition duration-150 ease-in-out">
          <span class="absolute left-0 inset-y-0 flex items-center pl-3">
            <svg class="h-5 w-5 text-indigo-500 group-hover:text-indigo-400 transition ease-in-out duration-150" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
            </svg>
          </span>
          Sign in
        </button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
//if(parent!==top) { // Check if we're in an iFrame. TODO: Fix this
  var connection = Penpal.connectToParent({
    // Methods child is exposing to parent. TODO: ADD ETHEREUM METHODS IN HERE
    methods: {
      arweaveCreateTransaction(data, callback) {
        var promise = new Promise((resolve, reject) => {
          arweave.createTransaction(data, jwk).then(function(response) {
            console.log("Before resolve = ", response);
            resolve(response);
          }).catch(function(e){
            reject(e);
          });
        });
        if (callback && typeof callback == 'function') {
            promise.then(callback.bind(null, null), callback);
        }
        return promise;
      },
      arweaveSign(tx, callback) {
        showConfirmation(tx.target, tx.quantity);
        console.log("Waiting for button push...");
        return new Promise((resy, rejy) => {
          document.getElementById('confirm-button').addEventListener('click',function(e) {
          // Dummy wallet for generating dummy object:
          console.log("RUNNING REST OF THIS");
          var test_jwk = { d: "ck9wAIHqTn7nCqKvK41Mf5BfqZduLjofOwJ5JMC5JO6G386nFYPVXEAHvgHUp04d-m0aknw-VxuhYxizf4fEoeohhGVhKjqzprHDEjDUr5nxhjNg-xdlXXb5t4vl3nf9J9flmYvb9BszZhrpZbDHtuq0sV9ByR93NVwe8gqv8s_ONPG9e0ZLRXrFw_n7EDBHw0hCVwPAd4RirVmX6BNzbgevzjodixqGpHk7L18LXzMlYY2wfiktW64n-fiId0cQdtWk3xXcOHOxnEt12NoFWtY5VXxAUiCZlr9fb0BVK_NFZGZCUXa6Y64KrZyBLi0XqLIvLAIDFRvCU3FEP5SnUwwA_0DJX3X5JkFAiPkgODqjbn28elXxL-PyFxUsIkk8xlMb6EmmCa3RiK6GGCR1ZK2W0XIu9zO6wvbf7OzvI8YR5_RVXWYCmWORz-GQZdlDo4EaHzsQuy8PGMX6fZ8LG-g6gVKMEyLip5V4qP_KFZnOBYEqlHnqUblRzY2Gm5u-I1DIZMbgKlr_xfODoSIRe7jwTtDuSCTN3DxivOfIBYMlm80cuySpCiGjLPr_LdKfFxR-qBe6PXDKBNFgqCevTUDyH5DyPBPZmN5xhYmjT_fKD2z5hKDZ4euz9ujfwZjcVJ03wDjUfz2vmfCcWryH33rN1ntu-Iz9HWpfrElltGE", dp: "tnwH6efEsxA72KC58GGSCczwd9L67CrTsKhNlt_tctq_A0x9ZBDDbibE6b-udiXgSdFyPNNhf3XX87UGK1dym9XLmHEYCPBxCFqQLP9gu0Ej9Q2qZxJHIZ46Xv3XJjZe-50e6cLO9no4djz3cri9y5FNLKzMoF8S1D5aoRELb_njnA_ITXrDKcH9lHHBgzZg3K7dlafDKlHWBiRBG6G6wD4ugE7V_tzs5WSLZ42xZmlPiHgnKeCV6PKwnRBXbibl5NvJcc0eDgcCJWHSGOfqjPMOuvKSYJT0ae_iq_dclj3LX7_NMV4ARX_kROyTRXfB9bYaOuUiEKpw4Jki7vRt8Q", dq: "SKpQny0mw-oY6TvJNavCYjvXZjoBJwdA_4JnaMsY7y269AYrR1CDoK1axQ2tlaLCE4XvVyXgrML-36SUS6WeuvdSdnAkfhlVRTk8-ij9Sel54cw_ReL4tPktkYOo36ZsW1zTNaTeL0byfWPx5l8YA65Fd0-QwGpcrpqo7zV70teIMW5fa14-LoIw3gXuQvZ85Y4I91CnRR6ELQ7iob72iCxC_9G8F1zaXZdpnrubPWC6iVw_3-UFmipZCmSDIoyhV8_JyTKj6E8Udd75_4EX81wX75naItg5Pyw4mP5YnzK9mwdoyDP48E6QO7a6sgCAcnIC1nWjDsEf6oyuZr0xFQ", e: "AQAB", ext: true, kty: "RSA", n: "n64e3Kx8f8cFIzcT1JcU3t9dlG9xjJWgeQOUkSeaaGo6Lf8ImbdgwZWkA3UGZrq7Ap04SaKhwDDZjposQ89k0xi_c6a3pNTAKnWyXSHNfxY0FAUD_GD_kXOySl7uF_QaRyMxGFge5-CcdSdv8zjBgoMm2eQfkBT0evGNfVA46MDzFTyUwFp70ayN3R7KpYxob6nF-1zH0LUJ8L6z5qf-b8RyOifU5lrDVuO7r-jsPNfuIMy9x0LJIi1f-H6bAkoIgDJwV_mDiZ0umVXPho7dY2T4GOmSjetUOVIqd2NmJfrmZWGI08OP9QurB06tUKN3fJKKaYO3Zq-njkLfuT6Gt1Mv3XQ6dw29JHUWpXYslMCc-TqQeAYdgzcMY4HAHr-Ws6a068FfBxHVtgjof-aFvPSbbxkgnIYhF6LUnh3gD8mZB0BUH-fU3M_7U9zDaPgGtDnxOyaCVUN3qmBHQulak8X5liBXosTml8YKkyTIwJhhWLhpy0k6kQgIZI1kPecKXrsBB1_aj-NCLXjppR97gEsOZcaezk2TSIIT-G-I0FjmUY--XynGzQpq8H6MM-4aUKrJ2_AQn0bKm2Sd8YKlsm5hP5F6IZA-sWCi1E-ilXo7zfhUIRq3Zpj-LV0iZ_UZu1o0sf3I0EMoBAsCGilo79kT3yQJxCOkErVfa2ye4pM", p: "1HB6HYnVjvTA_sit0xZ0-WklYg61rG1IQ8rg5GB_RFInD_Mymxy8uuO_Ufur_Z5jPaunvIGAiljMfoNNBCw6S1fREBnU08Pfzt4-GOGc85ptBSMH19KElVMJC7cNJruFjo1YLY30ZqGEv-NlPeG8ItjcAwdIIIDelSjr4TQdi2SIKGVx5ACDIYdTz3ea9hq4h2bj-OTdabRCnC-d69veP8bhCNP5OReXPRZN1WevVGl0Kqvad0k68PEXdqL_vQ4GPOgEt-PXhjnFVyVlOBsU8Kxq33JT1PXfeNWs9sTZm-6LnKm7LQ1JLKNQYieeJj-NP6ntO59c-Z4lqo33q2plFw", q: "wGwrK4OlRlY21hAZgJgt5-v9vukKYrSKuA1k-o3VA4i8m3WCYQCkBkICPQ3WGa1O6olgExYvjAV1MS3qbNEDBCCzi82tKz7vkcKvCE5GzXpq2DAW3H35PAt8vmGGnjukiZXgxDP3OtueRle6rcQs1pi1MwQmBhf9B-1LJZAXF0G0WuMObU9yTAf6n5fcbSf09AVnpiY8p2xizNG6jtLfZcgH_H2dZJ_Z4I1pudxViHyfMVvQgKU6POImV4u1o4C6ZpoehknN8hETR8p1eEIx7JMfqMyT9zYhXO8bKkj7dE9dyQsTiRhJ8NSs2UBlC9so63OVy1A2KhnzBoMwyTRT5Q", qi: "cXWAHLucCcopSVkIVmvOQ50MktM6MRtuap3CebXF1p2rARPfG8baNgrXb9itLFSGacQUrXcrHRGhAd0i4RrIG6W-OGzNpz-F7cv_9s5Fihw7e9P1DZ0tyYz8r1Efm0WZum_4Hdm1vbrjaHGxgJWrX-tvO_Ou4FTcFISHgMI74tYFs_FbTLgL0CCy2TCJ4UJvdBJk1UlFqLfdGm1y8zh1QNzht_H3okoptn6J4hLhEFdMTnDMcsxWorW7SQ4jfGeg-5NAfDb9EJRGKrzDM7YJSPr04HMFWpwhtF_XZ-nTgdyrCNe_kqSA8ogNKVRD-e0Occ5JIUx80JLsvzymXT_Tgg", };

          return arweave.createTransaction({ target: '1seRanklLU_1VTGkEk7P0xAwMJfA7owA1JHW5KyZKlY', quantity: arweave.ar.arToWinston('0.0005') }, test_jwk).then(function(dummy) {
            Object.keys(tx).forEach(function(key) {
              dummy[key] = tx[key];
            });
            console.log("My page got: ", dummy);

            // Real code starts here:
            return arweave.transactions.sign(dummy, jwk).then(function(response) {
                return new Promise((resolve) => {
                  closeAll();
                  resy(dummy);
                });
              }).catch(function(e){
                //reject(e);
              });
          });

          }, {once: true});
        });
      }
    },
  });

  connection.promise.then((parent) => {
    iframeConnection = parent;
    closeModal = iframeConnection.closeModal;
  });
</script>

</body>
</html>
